# NorthStar full stack: run from this directory with: docker compose up -d --build
# --build builds the service images (discovery, gateway, auth, book, store, order, inventory, notification)
# from each module's Dockerfile; no pre-built images required. Postgres and Redis use hub images.

services:
  discovery:
    build: ./northstar-discovery-service
    image: northstar-discovery-service:latest
    container_name: northstar-discovery
    ports:
      - "8761:8761"
    networks:
      - northstar-net

  redis:
    image: redis:alpine
    container_name: northstar-redis
    ports:
      - "6379:6379"
    networks:
      - northstar-net

  postgres-auth:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_auth_db
    ports:
      - "5433:5432"
    volumes:
      - northstar_auth_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  postgres-book:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_book_db
    ports:
      - "5434:5432"
    volumes:
      - northstar_book_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  postgres-store:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_store_db
    ports:
      - "5435:5432"
    volumes:
      - northstar_store_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  postgres-order:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_order_db
    ports:
      - "5436:5432"
    volumes:
      - northstar_order_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  postgres-inventory:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_inventory_db
    ports:
      - "5437:5432"
    volumes:
      - northstar_inventory_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  postgres-notification:
    image: postgres:alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: northstar_notification_db
    ports:
      - "5438:5432"
    volumes:
      - northstar_notification_pgdata:/var/lib/postgresql/data
    networks:
      - northstar-net

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: northstar-pgadmin
    ports:
      - "5051:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    depends_on:
      - postgres-auth
      - postgres-book
      - postgres-store
      - postgres-order
      - postgres-inventory
      - postgres-notification
    networks:
      - northstar-net

  gateway:
    build: ./northstar-gateway-service
    image: northstar-gateway-service:latest
    container_name: northstar-gateway
    ports:
      - "8181:8181"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    depends_on:
      - discovery
      - redis
    networks:
      - northstar-net

  auth:
    build: ./northstar-auth-service
    image: northstar-auth-service:latest
    container_name: northstar-auth
    ports:
      - "8191:8191"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      DB_HOST: postgres-auth
      DB_PORT: "5432"
      DB_NAME: northstar_auth_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-auth
    networks:
      - northstar-net

  book:
    build: ./northstar-book-service
    image: northstar-book-service:latest
    container_name: northstar-book
    ports:
      - "8186:8186"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      AUTH_SERVER_URL: http://gateway:8181/api/auth/oauth2/jwks
      DB_HOST: postgres-book
      DB_PORT: "5432"
      DB_NAME: northstar_book_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-book
    networks:
      - northstar-net

  store:
    build: ./northstar-store-service
    image: northstar-store-service:latest
    container_name: northstar-store
    ports:
      - "8187:8187"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      AUTH_SERVER_URL: http://gateway:8181/api/auth/oauth2/jwks
      DB_HOST: postgres-store
      DB_PORT: "5432"
      DB_NAME: northstar_store_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-store
    networks:
      - northstar-net

  order:
    build: ./northstar-order-service
    image: northstar-order-service:latest
    container_name: northstar-order
    ports:
      - "8188:8188"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      AUTH_SERVER_URL: http://gateway:8181/api/auth/oauth2/jwks
      DB_HOST: postgres-order
      DB_PORT: "5432"
      DB_NAME: northstar_order_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-order
    networks:
      - northstar-net

  inventory:
    build: ./northstar-inventory-service
    image: northstar-inventory-service:latest
    container_name: northstar-inventory
    ports:
      - "8189:8189"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      AUTH_SERVER_URL: http://gateway:8181/api/auth/oauth2/jwks
      DB_HOST: postgres-inventory
      DB_PORT: "5432"
      DB_NAME: northstar_inventory_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-inventory
    networks:
      - northstar-net

  notification:
    build: ./northstar-notification-service
    image: northstar-notification-service:latest
    container_name: northstar-notification
    ports:
      - "8190:8190"
    environment:
      DISCOVERY_SERVER_URL: http://discovery:8761/eureka/
      BASE_URL: http://gateway:8181
      AUTH_SERVER_URL: http://gateway:8181/api/auth/oauth2/jwks
      DB_HOST: postgres-notification
      DB_PORT: "5432"
      DB_NAME: northstar_notification_db
      DB_USER: postgres
      DB_PASS: root
    depends_on:
      - discovery
      - postgres-notification
    networks:
      - northstar-net

volumes:
  northstar_auth_pgdata:
  northstar_book_pgdata:
  northstar_store_pgdata:
  northstar_order_pgdata:
  northstar_inventory_pgdata:
  northstar_notification_pgdata:

networks:
  northstar-net:
    driver: bridge
